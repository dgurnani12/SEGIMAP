\documentclass[a4paper,12pt]{article}
\usepackage{multicol}
\usepackage[utf8]{inputenc}

\usepackage[T1]{fontenc}

\usepackage{svg}
% Fix svg rendering
\DeclareUnicodeCharacter{00A0}{ }

\begin{document}

\begin{titlepage}
\begin{center}
    \bfseries
    \huge University of Ottawa
    \vskip.2in
    \large SEG 2105
    \vskip1in
    \Large Assignment 5
    \vskip1.5in
    \emph{\huge IMAP Client-Server Implementation Outline}
\end{center}

\vskip1.4in

\begin{minipage}{.25\textwidth}
    \begin{flushleft}
        \bfseries\large Professor:\par \emph{Prof. Timothy Lethbridge}
    \end{flushleft}
\end{minipage}
\hskip.4\textwidth
\begin{minipage}{.25\textwidth}
    \begin{flushleft}
        \bfseries\large Students:\par \emph{Nikita Pekin (7216924)} \\
        \par \emph{William Pearson (7204884)}
    \end{flushleft}
\end{minipage}
\end{titlepage}

\section*{Problem Statement}

The problem being solved is the storage, retrieval, and manipulation of electronic mail on clients and servers.

\section*{Requirements}

The system will utilize the Internet Message Access Protocol to allow clients to retrieve and manipulate electronic mail. The system will utilize the Local Message Transfer Protocol in order to receieve messages for storage. The system should permit the organization of mail into folders. % The system should permit its clients to search through mail.

The system should respond to all client requests within a reasonable time frame (one or two seconds). It should allow multiple clients to log in as the same user and manipulate that user's mail concurrently. The system's state should not be corrupted as a result of such concurrent usage. The system should be modular enough that it may be easily extended to speak SMTP, POP3 or any other future internet message protocol.

The system will be designed to run on Unix-based and Unix-like systems. The system will utilize the filesystem for persistent storage of system configuration and user's messages.

The system will be implemented in the  rust programming language. This programming language is fairly new --- not yet at version 1.0 --- and currently under active development by Mozilla. This means that rust is not currently stable and will have frequent breaking changes. To avoid these breakages, our code will be built against Rust v0.12 (the latest stable release as of November 1, 2014).

There are many good reasons to choose Rust. It is a type-safe and memory-safe systems language appropriate for applications such as an IMAP server. It is incredibly performant, rivalling C on various benchmarks, while also providing a very powerful concurrency system, which will allow the server to handle very high numbers of connections simultaneously and easily, through the use of lightweight task threads.

The system shall be complete by December 1, 2014. Some functional requirements may be dropped in order to comply with this hard deadline.

\newpage

\section*{Use Cases}

\begin{enumerate}

\item Login to the Mail Server

Preconditions: User has not yet configured their mail client

  \begin{multicols}{2}
    \begin{itemize}
    \item User starts their mail client
      \\
    \item User enters server and login information
      \vfill \columnbreak
    \item Mail client prompts user for server and login information
    \item Mail client successfully logs in and is able to perform authenticated commands
    \end{itemize}
  \end{multicols}


\item Read and Delete Individual Messages

Preconditions: User has configured their mail client to log in

  \begin{multicols}{2}
    \begin{itemize}
    \item User starts their mail client
      \\
    \item User selects a message to view
      \vfill \columnbreak
    \item Mail client displays a list of messages to the user
    \item Mail client displays the contents and header of the selected message
    \end{itemize}
  \end{multicols}

Preconditions: User can see at least one message

  \begin{multicols}{2}
    \begin{itemize}
    \item User uses their mail client's ``Delete Message'' function
      \\
    \item User exits the mail client or performs another triggering event
      \vfill \columnbreak
    \item Mail client marks the message for deletion on the server
    \item Mail client tells the server to delete all the marked messages
    \end{itemize}
  \end{multicols}

\item Create and Delete Folders

Preconditions: User has configured their mail client to log in

  \begin{multicols}{2}
    \begin{itemize}
    \item User uses their mail client's ``Create Folder'' function
    \item User enters a folder name
      \vfill \columnbreak
    \item Mail client prompts the user for a folder name
    \item Mail client creates the folder on the mail server
    \end{itemize}
  \end{multicols}

Preconditions: User has configured their mail client to log in; User has created at least one folder.

  \begin{multicols}{2}
    \begin{itemize}
    \item User selects a folder and uses their mail client's ``Delete Folder'' function
      \vfill \columnbreak
    \item Mail client deletes the folder on the mail server
    \end{itemize}
  \end{multicols}

\item Mark messages as read

Preconditions: User has configured their mail client to log in

  \begin{multicols}{2}
    \begin{itemize}
    \item User opens their mail client
      \\
    \item User views a message or marks it as `read'
      \vfill \columnbreak
    \item Mail client clearly marks `unread' and `recent' messages
    \item Mail client marks the message as `read' on the server
    \end{itemize}
  \end{multicols}

\end{enumerate}

\section*{Architecture}

The server will have to handle many individual tasks.
The server's core responsibility will be storing individual messages in folders, where the folders will be owned by certain users.
The server will have to be able to search through these folders, search through the messages, be able to parse the messages into their equivalent Rust data structures, and perform operations on these messages and folders.
The server will have to be able to listen to incoming connections from IMAP clients, be able to successfully understand these connections and respond to them to form an IMAP connection.
The server will have to create and handle these connections concurrently, and be able to use these connections to respond to commands coming from the IMAP client.

The IMAP client will need to be able to connect to a server.
The IMAP client will need to be able to translate user actions into commands sent to the server.
The IMAP client will also need to be able to understand responses from the server and represent the responses via local data structures.
The client will need to be able to store a representation of the way messages are organized on the server.
This representation will need to update based on responses from the server.
The client will need to be able to provide the user with common features (search, display, filtering), which will all need to be implemented with commands.
The exact implementation will vary depending on situation, but for this project, only the server will be implemented.
This means that as long as the client implements the IMAP protocol sufficiently, the rest of the implementation details will not matter.

We will use the Maildir format for persistent mail data storage. This means that messages will be persisted via the filesystem rather than via a database.

Our implementation will focus purely on the server aspect as IMAP (being a standardized protocol) allows the server to communicate with any pre-existing, compatible IMAP client. Because only the server will be written, UI and message display will not be a factor in the design.

The server itself will be written entirely in Rust, and use the Rust compilation utilities: the Rust compiler (rustc), LLVM (the bytecode backend), the Cargo package manager (for dependency management). Due to Rust and IMAP's platform agnosticism, the server binaries will be entirely platform agnostic - running in Windows, OS X, and Linux without issue. The server will also be able to communicate with IMAP clients on any platform.

The user authentication information will be stored in flatfiles on the disk in the TOML format. This means that the rust-toml library will be used to parse the TOML files. The authentication information will consist of the user's username (their email), and a salted hash of their password, encrypted with the bcrypt cryptographic hashing algorithm, through the rust-crypto library.

If time constraints permit, TLS authentication and encryption will be implemented using a suitable rust TLS library. Until then, authentication and IMAP interfacing will occur in plain-text. Typically, plain-text communication would be a glaring vulnerability in this scenario, but is considered acceptable as this software is not meant for public use.

\section*{List of Messages}

Client commands:

\$folder, \$username and \$password should be fairly obvious from context. \$msgid is the sequence number of a message in a selected folder. \$items indicate a range of possible values which indicate different subsets of a message. \$flags indicate a list of the possible flags which may be set on a message. \{\} indicate a list of possible values; () indicate optional values.

\begin{itemize}
\item LOGIN \$username \$password
\item SELECT \$folder
\item CREATE \$folder
\item DELETE \$folder
\item CLOSE
\item FETCH \$msgid \$items
\item STORE \{,+,-\}FLAGS(.SILENT) \$flags
\end{itemize}

Server responses:

\$command is the client command being responded to. \$success is a success message; \$error is an error message.

\begin{itemize}
\item OK \$command \$success
\item NO \$command \$error
\item BAD \$error
\item BYE
\end{itemize}

\section*{UML Class Diagram}

\begin{figure}[h]
    \centering
    \includesvg[height=\textheight,width=\textwidth]{imapuml}
    \caption{UML Class Diagram}
\end{figure}

\end{document}
